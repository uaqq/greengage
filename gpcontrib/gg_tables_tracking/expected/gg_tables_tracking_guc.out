-- start_matchsubs
--
-- m/ERROR:  \[gg_tables_tracking\] exceeded maximum number of tracked databases \(track_files\.c:\d+\)/
-- s/\d+/XXX/g
--
-- end_matchsubs
-- Test database registering GUC.
CREATE DATABASE tracking1;
\c tracking1;
CREATE EXTENSION gg_tables_tracking;
SHOW gg_tables_tracking.tracking_is_db_tracked;
 gg_tables_tracking.tracking_is_db_tracked 
-------------------------------------------
 off
(1 row)

SELECT datname, setconfig FROM pg_db_role_setting JOIN pg_database ON
setdatabase=oid WHERE datname=current_database();
 datname | setconfig 
---------+-----------
(0 rows)

SELECT gg_tables_tracking.wait_for_worker_initialize();
 wait_for_worker_initialize 
----------------------------
 t
(1 row)

SELECT gg_tables_tracking.tracking_register_db();
 tracking_register_db 
----------------------
 t
(1 row)

SHOW gg_tables_tracking.tracking_is_db_tracked;
 gg_tables_tracking.tracking_is_db_tracked 
-------------------------------------------
 on
(1 row)

SELECT datname, setconfig FROM pg_db_role_setting JOIN pg_database ON
setdatabase=oid WHERE datname=current_database();
  datname  |                   setconfig                   
-----------+-----------------------------------------------
 tracking1 | {gg_tables_tracking.tracking_is_db_tracked=t}
(1 row)

SELECT gg_tables_tracking.tracking_unregister_db();
 tracking_unregister_db 
------------------------
 t
(1 row)

SHOW gg_tables_tracking.tracking_is_db_tracked;
 gg_tables_tracking.tracking_is_db_tracked 
-------------------------------------------
 off
(1 row)

SELECT datname, setconfig FROM pg_db_role_setting JOIN pg_database ON
setdatabase=oid WHERE datname=current_database();
  datname  |                   setconfig                   
-----------+-----------------------------------------------
 tracking1 | {gg_tables_tracking.tracking_is_db_tracked=f}
(1 row)

-- Prohibit manual GUC setting.
SET gg_tables_tracking.tracking_is_db_tracked = true;
ERROR:  cannot change tracking status outside the tracking_register_db function
ALTER DATABASE tracking1 SET gg_tables_tracking.tracking_is_db_tracked = true;
ERROR:  cannot change tracking status outside the tracking_register_db function
-- Test limit of tracking databases.
SHOW gg_tables_tracking.tracking_db_track_count;
 gg_tables_tracking.tracking_db_track_count 
--------------------------------------------
 5
(1 row)

CREATE DATABASE tracking2;
CREATE DATABASE tracking3;
CREATE DATABASE tracking4;
CREATE DATABASE tracking5;
CREATE DATABASE tracking6;
DO $$
DECLARE
    db_oid oid;
BEGIN
    FOR db_oid IN 
        SELECT oid 
        FROM pg_database 
        WHERE datname IN ('tracking1', 'tracking2', 'tracking3',
        'tracking4', 'tracking5', 'tracking6')
    LOOP
        PERFORM gg_tables_tracking.tracking_register_db(db_oid);
    END LOOP;
END;
$$;
ERROR:  [gg_tables_tracking] exceeded maximum number of tracked databases (track_files.c:659)
CONTEXT:  SQL statement "SELECT gg_tables_tracking.tracking_register_db(db_oid)"
PL/pgSQL function inline_code_block line 11 at PERFORM
DO $$
DECLARE
    db_oid oid;
BEGIN
    FOR db_oid IN 
        SELECT oid 
        FROM pg_database 
        WHERE datname IN ('tracking1', 'tracking2', 'tracking3',
        'tracking4', 'tracking5', 'tracking6')
    LOOP
        PERFORM gg_tables_tracking.tracking_unregister_db(db_oid);
    END LOOP;
END;
$$;
DROP DATABASE IF EXISTS tracking2;
DROP DATABASE IF EXISTS tracking3;
DROP DATABASE IF EXISTS tracking4;
DROP DATABASE IF EXISTS tracking5;
DROP DATABASE IF EXISTS tracking6;
-- Test gg_tables_tracking.tracking_snapshot_on_recovery GUC
SELECT gg_tables_tracking.tracking_set_snapshot_on_recovery(true);
 tracking_set_snapshot_on_recovery 
-----------------------------------
 t
(1 row)

SELECT datname, setconfig FROM pg_db_role_setting JOIN pg_database ON
setdatabase=oid WHERE datname=current_database();
  datname  |                                            setconfig                                             
-----------+--------------------------------------------------------------------------------------------------
 tracking1 | {gg_tables_tracking.tracking_is_db_tracked=f,gg_tables_tracking.tracking_snapshot_on_recovery=t}
(1 row)

-- Prohibit manual GUC setting.
SET gg_tables_tracking.tracking_snapshot_on_recovery = false;
ERROR:  cannot change tracking status outside the tracking_set_snapshot_on_recovery function
ALTER DATABASE tracking1 SET gg_tables_tracking.tracking_snapshot_on_recovery = false;
ERROR:  cannot change tracking status outside the tracking_set_snapshot_on_recovery function
-- Test gg_tables_tracking.tracking_relams GUC
SELECT gg_tables_tracking.tracking_set_relams('heap, ao_column, brin');
 tracking_set_relams 
---------------------
 t
(1 row)

SELECT datname, setconfig FROM pg_db_role_setting JOIN pg_database ON
setdatabase=oid WHERE datname=current_database();
  datname  |                                                                         setconfig                                                                         
-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------
 tracking1 | {gg_tables_tracking.tracking_is_db_tracked=f,gg_tables_tracking.tracking_snapshot_on_recovery=t,"gg_tables_tracking.tracking_relams=heap,ao_column,brin"}
(1 row)

SELECT gg_tables_tracking.tracking_set_relams('v,v,v,,,');
ERROR:  access method "v" does not exist
SELECT datname, setconfig FROM pg_db_role_setting JOIN pg_database ON
setdatabase=oid WHERE datname=current_database();
  datname  |                                                                         setconfig                                                                         
-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------
 tracking1 | {gg_tables_tracking.tracking_is_db_tracked=f,gg_tables_tracking.tracking_snapshot_on_recovery=t,"gg_tables_tracking.tracking_relams=heap,ao_column,brin"}
(1 row)

SELECT gg_tables_tracking.tracking_set_relams('d,b,c');
ERROR:  access method "d" does not exist
SELECT gg_tables_tracking.tracking_set_relams('');
 tracking_set_relams 
---------------------
 t
(1 row)

SELECT datname, setconfig FROM pg_db_role_setting JOIN pg_database ON
setdatabase=oid WHERE datname=current_database();
  datname  |                                                              setconfig                                                               
-----------+--------------------------------------------------------------------------------------------------------------------------------------
 tracking1 | {gg_tables_tracking.tracking_is_db_tracked=f,gg_tables_tracking.tracking_snapshot_on_recovery=t,gg_tables_tracking.tracking_relams=}
(1 row)

-- Prohibit manual GUC setting.
SET gg_tables_tracking.tracking_relams = "heap, ao_column, brin";
ERROR:  cannot change tracking status outside the tracking_register_relams function
ALTER DATABASE tracking1 SET gg_tables_tracking.tracking_relams = "heap, ao_column, brin";
ERROR:  cannot change tracking status outside the tracking_register_relams function
-- Resetting case is allowed.
ALTER DATABASE tracking1 RESET gg_tables_tracking.tracking_relams;
-- Test gg_tables_tracking.tracking_relkinds GUC
SELECT gg_tables_tracking.tracking_set_relkinds('r,t,o,S');
 tracking_set_relkinds 
-----------------------
 t
(1 row)

SELECT datname, setconfig FROM pg_db_role_setting JOIN pg_database ON
setdatabase=oid WHERE datname=current_database();
  datname  |                                                                    setconfig                                                                    
-----------+-------------------------------------------------------------------------------------------------------------------------------------------------
 tracking1 | {gg_tables_tracking.tracking_is_db_tracked=f,gg_tables_tracking.tracking_snapshot_on_recovery=t,"gg_tables_tracking.tracking_relkinds=r,t,o,S"}
(1 row)

SELECT gg_tables_tracking.tracking_set_relkinds('m,M,o,,,');
 tracking_set_relkinds 
-----------------------
 t
(1 row)

SELECT datname, setconfig FROM pg_db_role_setting JOIN pg_database ON
setdatabase=oid WHERE datname=current_database();
  datname  |                                                                   setconfig                                                                   
-----------+-----------------------------------------------------------------------------------------------------------------------------------------------
 tracking1 | {gg_tables_tracking.tracking_is_db_tracked=f,gg_tables_tracking.tracking_snapshot_on_recovery=t,"gg_tables_tracking.tracking_relkinds=m,M,o"}
(1 row)

SELECT gg_tables_tracking.tracking_set_relkinds('d,b,c');
ERROR:  Invalid relkind: d
HINT:  Valid relkinds are: 'r', 'i', 'S', 't', 'v', 'c', 'f', 'u', 'm', 'o', 'b', 'M'
SELECT gg_tables_tracking.tracking_set_relkinds('');
 tracking_set_relkinds 
-----------------------
 t
(1 row)

SELECT datname, setconfig FROM pg_db_role_setting JOIN pg_database ON
setdatabase=oid WHERE datname=current_database();
  datname  |                                                               setconfig                                                                
-----------+----------------------------------------------------------------------------------------------------------------------------------------
 tracking1 | {gg_tables_tracking.tracking_is_db_tracked=f,gg_tables_tracking.tracking_snapshot_on_recovery=t,gg_tables_tracking.tracking_relkinds=}
(1 row)

-- Prohibit manual GUC setting.
SET gg_tables_tracking.tracking_relkinds = "h, a, x";
ERROR:  cannot change tracking status outside the tracking_register_relkinds function
ALTER DATABASE tracking1 SET gg_tables_tracking.tracking_relkinds = "h, a, x";
ERROR:  cannot change tracking status outside the tracking_register_relkinds function
-- Resetting case is allowed.
ALTER DATABASE tracking1 RESET gg_tables_tracking.tracking_relkinds;
-- Test gg_tables_tracking.tracking_schemas GUC
SELECT gg_tables_tracking.tracking_unregister_schema('public');
 tracking_unregister_schema 
----------------------------
 t
(1 row)

SELECT datname, setconfig FROM pg_db_role_setting JOIN pg_database ON
setdatabase=oid WHERE datname=current_database();
  datname  |                                                                                                 setconfig                                                                                                 
-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 tracking1 | {gg_tables_tracking.tracking_is_db_tracked=f,gg_tables_tracking.tracking_snapshot_on_recovery=t,"gg_tables_tracking.tracking_schemas=gg_tables_tracking,pg_catalog,pg_toast,pg_aoseg,information_schema"}
(1 row)

SELECT gg_tables_tracking.tracking_register_schema('gg_tables_tracking');
 tracking_register_schema 
--------------------------
 t
(1 row)

SELECT gg_tables_tracking.tracking_register_schema('public');
 tracking_register_schema 
--------------------------
 t
(1 row)

SELECT datname, setconfig FROM pg_db_role_setting JOIN pg_database ON
setdatabase=oid WHERE datname=current_database();
  datname  |                                                                                                    setconfig                                                                                                     
-----------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 tracking1 | {gg_tables_tracking.tracking_is_db_tracked=f,gg_tables_tracking.tracking_snapshot_on_recovery=t,"gg_tables_tracking.tracking_schemas=gg_tables_tracking,pg_catalog,pg_toast,pg_aoseg,information_schema,public"}
(1 row)

SELECT gg_tables_tracking.tracking_unregister_schema('public');
 tracking_unregister_schema 
----------------------------
 t
(1 row)

SELECT datname, setconfig FROM pg_db_role_setting JOIN pg_database ON
setdatabase=oid WHERE datname=current_database();
  datname  |                                                                                                 setconfig                                                                                                 
-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 tracking1 | {gg_tables_tracking.tracking_is_db_tracked=f,gg_tables_tracking.tracking_snapshot_on_recovery=t,"gg_tables_tracking.tracking_schemas=gg_tables_tracking,pg_catalog,pg_toast,pg_aoseg,information_schema"}
(1 row)

SELECT gg_tables_tracking.tracking_register_schema('pg_pg');
ERROR:  schema pg_pg does not exist
-- Prohibit manual GUC setting.
SET gg_tables_tracking.tracking_schemas = "pg_catalog, mychema";
ERROR:  cannot change tracking status outside the tracking_register_schema function
ALTER DATABASE tracking1 SET gg_tables_tracking.tracking_schemas =  "pg_catalog, mychema";
ERROR:  cannot change tracking status outside the tracking_register_schema function
-- Resetting case is allowed.
ALTER DATABASE tracking1 RESET gg_tables_tracking.tracking_schemas;
-- Test GUCs are set in the caller's session.
SELECT gg_tables_tracking.tracking_register_db();
 tracking_register_db 
----------------------
 t
(1 row)

SHOW gg_tables_tracking.tracking_is_db_tracked;
 gg_tables_tracking.tracking_is_db_tracked 
-------------------------------------------
 on
(1 row)

SELECT gg_tables_tracking.tracking_unregister_db();
 tracking_unregister_db 
------------------------
 t
(1 row)

SHOW gg_tables_tracking.tracking_is_db_tracked;
 gg_tables_tracking.tracking_is_db_tracked 
-------------------------------------------
 off
(1 row)

SELECT gg_tables_tracking.tracking_set_snapshot_on_recovery(true);
 tracking_set_snapshot_on_recovery 
-----------------------------------
 t
(1 row)

SHOW gg_tables_tracking.tracking_snapshot_on_recovery;
 gg_tables_tracking.tracking_snapshot_on_recovery 
--------------------------------------------------
 on
(1 row)

SELECT gg_tables_tracking.tracking_set_snapshot_on_recovery(false);
 tracking_set_snapshot_on_recovery 
-----------------------------------
 t
(1 row)

SHOW gg_tables_tracking.tracking_snapshot_on_recovery;
 gg_tables_tracking.tracking_snapshot_on_recovery 
--------------------------------------------------
 off
(1 row)

SHOW gg_tables_tracking.tracking_schemas;
                gg_tables_tracking.tracking_schemas                 
--------------------------------------------------------------------
 gg_tables_tracking,pg_catalog,pg_toast,pg_aoseg,information_schema
(1 row)

SELECT gg_tables_tracking.tracking_register_schema('gg_tables_tracking');
 tracking_register_schema 
--------------------------
 t
(1 row)

SHOW gg_tables_tracking.tracking_schemas;
                    gg_tables_tracking.tracking_schemas                    
---------------------------------------------------------------------------
 public,gg_tables_tracking,pg_catalog,pg_toast,pg_aoseg,information_schema
(1 row)

SELECT gg_tables_tracking.tracking_unregister_schema('gg_tables_tracking');
 tracking_unregister_schema 
----------------------------
 t
(1 row)

SHOW gg_tables_tracking.tracking_schemas;
          gg_tables_tracking.tracking_schemas           
--------------------------------------------------------
 public,pg_catalog,pg_toast,pg_aoseg,information_schema
(1 row)

SHOW gg_tables_tracking.tracking_relkinds;
 gg_tables_tracking.tracking_relkinds 
--------------------------------------
 
(1 row)

SELECT gg_tables_tracking.tracking_set_relkinds('r,t');
 tracking_set_relkinds 
-----------------------
 t
(1 row)

SHOW gg_tables_tracking.tracking_relkinds;
 gg_tables_tracking.tracking_relkinds 
--------------------------------------
 r,t
(1 row)

SHOW gg_tables_tracking.tracking_relams;
 gg_tables_tracking.tracking_relams 
------------------------------------
 
(1 row)

SELECT gg_tables_tracking.tracking_set_relams('ao_row');
 tracking_set_relams 
---------------------
 t
(1 row)

SHOW gg_tables_tracking.tracking_relams;
 gg_tables_tracking.tracking_relams 
------------------------------------
 ao_row
(1 row)

\c contrib_regression;
DROP DATABASE tracking1;
