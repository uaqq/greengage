-- Used to be a bug where we release the gangs and reset context. The
-- subsequent retry succeeds with the new gang. When resetting the
-- session, as the warning message says, we drop ongoing temporary
-- namespace. However, whenever new temporary namespace is created, we
-- install shmem_exit callback for this namespace clean up. We earlier
-- missed to uninstall this callback on resetting the gang. That was
-- the reason this test exposed out of shmem_exit slots. Currently
-- MAX_ON_EXITS is set to 20 hence creates 20 transactions. Erroring
-- commit_prepared first time is used as vehicle to trigger gang
-- reset.
-- start_matchsubs
-- m/WARNING:.*Any temporary tables for this session have been dropped because the gang was disconnected/
-- s/session id \=\s*\d+/session id \= DUMMY/gm
-- end_matchsubs
CREATE TABLE foo(a int, b int);
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'a' as the Greenplum Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
-- 1
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error','commit_prepared',
	'','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21476, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 529)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 2
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error','commit_prepared',
	'','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21478, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 530)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 3
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error',
	               'commit_prepared', '','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21480, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 531)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 4
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error','commit_prepared',
	'','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21482, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 532)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 5
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error','commit_prepared',
	'','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21484, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 533)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 6
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error',
                       'commit_prepared', '','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21486, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 534)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 7
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error',
                       'commit_prepared', '','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21488, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 535)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 8
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error',
	               'commit_prepared', '','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21490, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 536)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 9
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error',
                       'commit_prepared','','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21492, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 537)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 10
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error','commit_prepared',
	'','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21494, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 538)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 11
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error',
	'commit_prepared', '','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21496, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 539)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 12
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error',
	'commit_prepared', '','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21498, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 540)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 13
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error',
	'commit_prepared', '','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21500, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 541)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 14
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error',
	'commit_prepared', '','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21502, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 542)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 15
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error',
	'commit_prepared', '','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21504, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 543)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 16
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error',
	'commit_prepared', '','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21506, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 544)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 17
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error',
	'commit_prepared', '','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21508, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 545)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 18
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error',
	'commit_prepared', '','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21510, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 546)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 19
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error',
	'commit_prepared', '','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21512, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 548)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

-- 20
CREATE TEMP TABLE foo_stg AS SELECT * FROM foo;
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause. Creating a NULL policy entry.
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','error',
	'commit_prepared', '','',1,1,0,dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

DROP TABLE foo_stg;
WARNING:  the distributed transaction 'Commit Prepared' broadcast failed to one or more segments. Retrying ... try 1
DETAIL:  gid=21514, state=Retry Commit Prepared
NOTICE:  Releasing segworker group to retry broadcast.
WARNING:  Any temporary tables for this session have been dropped because the gang was disconnected (session id = 549)
SELECT gp_inject_fault('exec_mpp_dtx_protocol_command_start','reset',dbid)
  FROM gp_segment_configuration WHERE mode='s' and content=1 and role='p' ;
 gp_inject_fault 
-----------------
 Success:
(1 row)

