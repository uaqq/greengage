# Main CI pipeline orchestrating build, test, and upload stages
name: Greengage CI

on:
  push:
    branches: ['main']  # Trigger on push to main (after merged PR)
    tags: ['6.*']   # Trigger on tags for versioned releases
  pull_request:
    branches: ['**'] # Trigger on pull requests for all branches

# Concurrency control to cancel previous runs on new push to same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.event.pull_request.number || github.ref }}
  cancel-in-progress: true  # Automatically cancel any previous runs for the same group

jobs:
  build:
    strategy:
      fail-fast: true  # Stop on any failure in the matrix
      matrix:
        target_os: [ubuntu]
    permissions:
      contents: read  # Explicit for default behavior
      packages: write # Required for GHCR access
      actions: write  # Required for artifact upload
    uses: greengagedb/greengage-ci/.github/workflows/greengage-reusable-build.yml@v13
    with:
      version: 6
      target_os: ${{ matrix.target_os }}
    secrets:
      ghcr_token: ${{ secrets.GITHUB_TOKEN }}

  resgroup-tests:
    needs: build
    if: github.event_name == 'pull_request'  # Only for PR
    strategy:
      fail-fast: true
      matrix:
        target_os: [ubuntu]
    permissions:
      contents: read  # Explicit for default behavior
      packages: read  # Explicit for GHCR access clarity
      actions: write  # Required for artifact upload
    uses: greengagedb/greengage-ci/.github/workflows/greengage-reusable-tests-resgroup.yml@v13
    with:
      version: 6
      target_os: ${{ matrix.target_os }}
    secrets:
      ghcr_token: ${{ secrets.GITHUB_TOKEN }}

